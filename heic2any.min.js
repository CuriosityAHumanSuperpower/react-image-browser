(function(){
  // Lightweight local loader/shim for heic2any.
  // If the real library is present, this does nothing. Otherwise it will try
  // to load the CDN copy on first invocation and queue requests until ready.
  if(typeof window === 'undefined') return;
  if(window.heic2any) return;

  var loading = false;
  var queue = [];

  function notifyFailure(){
    try{
      alert('HEIC converter could not be loaded from the CDN and no local build was found.\n\nPlace a copy of heic2any.min.js (and any required WASM) next to this file or allow internet access to load from the CDN.');
    }catch(e){ /* ignore */ }
  }

  window.heic2any = function(opts){
    return new Promise(function(resolve,reject){
      // If a real implementation is already present (not this loader), call it
      if(typeof window.heic2any === 'function' && !window.heic2any.__isLoader){
        try{
          Promise.resolve(window.heic2any(opts)).then(resolve).catch(reject);
          return;
        }catch(err){ reject(err); return; }
      }

      // queue request
      queue.push({opts,resolve,reject});

      if(loading) return;
      loading = true;

      // Try to fetch the CDN script dynamically (best-effort)
      var s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/heic2any@0.6.0/dist/heic2any.min.js';
      s.async = true;
      s.onload = function(){
        loading = false;
        // If the CDN script set window.heic2any to a real implementation, process queue
        if(typeof window.heic2any === 'function' && !window.heic2any.__isLoader){
          queue.forEach(function(q){
            try{
              Promise.resolve(window.heic2any(q.opts)).then(q.resolve).catch(q.reject);
            }catch(err){ q.reject(err); }
          });
          queue = [];
          return;
        }
        // If it didn't replace the loader, reject queued items
        queue.forEach(function(q){ q.reject(new Error('heic2any did not initialize after loading the CDN script')); });
        queue = [];
        notifyFailure();
      };
      s.onerror = function(){
        loading = false;
        queue.forEach(function(q){ q.reject(new Error('Failed to load heic2any from CDN')); });
        queue = [];
        // Try to give the user actionable feedback
        notifyFailure();
      };
      document.head.appendChild(s);
    });
  };
  // mark this function as the loader to avoid recursion
  window.heic2any.__isLoader = true;
})();
